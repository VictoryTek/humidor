# Humidor v1.4.1 Release Notes

**Release Date:** December 14, 2025

## ğŸ¯ Overview

Version 1.4.1 introduces the highly-requested cigar transfer feature, allowing you to easily move cigars between humidors. This release includes comprehensive frontend and backend implementation with proper permission handling and UI improvements.

---

## âœ¨ New Features

### Cigar Transfer Between Humidors

Transfer cigars from one humidor to another with a streamlined workflow:

- **Transfer Button**: Located conveniently under the cigar image in the detail report card
- **Quantity Control**: Choose to transfer all cigars or specify a custom quantity
- **Permission-Aware**: Respects humidor ownership and sharing permissions
  - Can transfer from owned humidors or shared humidors with edit permissions
  - Destination humidor must also be owned or shared with edit access
- **Automatic Updates**: Source and destination humidor stats refresh automatically after transfer
- **Transaction Safety**: Database transactions ensure data consistency
- **Intelligent State Management**: Hub page maintains accurate cigar counts when navigating between humidors

**Transfer Modal Features:**
- Dropdown selector for destination humidor
- Numeric input for quantity with validation
- "Transfer All" option for convenience
- Real-time validation prevents invalid transfers
- Clear error messaging for edge cases

**Backend Implementation:**
- New POST `/api/v1/cigars/:id/transfer` endpoint
- Ownership verification for both source and destination humidors
- Handles partial transfers (creates new cigar entry) and full transfers (updates or deletes source)
- Proper quantity validation and same-humidor prevention
- Full support for nullable organizer fields (brand, size, strength, origin, wrapper, ring gauge)

---

## ğŸ”§ Technical Improvements

### Frontend State Management

**Global Cigars Array Optimization**
- Fixed bug where navigating between humidor detail views corrupted hub page stats
- Improved state management to maintain complete cigar data for all humidors
- Hub statistics now remain accurate regardless of navigation patterns

**Implementation Details:**
- Detail view updates global cigars array intelligently by removing old data for the current humidor and adding fresh data
- Preserves cigars from other humidors to maintain accurate hub page calculations
- Eliminates the "stats showing 0" bug when switching between humidors

### Backend Schema Handling

**Nullable Field Support**
- Properly handles all nullable UUID fields in cigar transfer operations
- Correct type mapping for PostgreSQL `timestamp with time zone` (DateTime<Utc>)
- All organizer fields (brand_id, size_id, strength_id, origin_id, wrapper, ring_gauge_id) correctly serialize as Option<Uuid>

### Route Organization

**Improved Routing Logic**
- Transfer route properly ordered before generic UUID routes to prevent path matching conflicts
- Maintains clear separation of concerns between CRUD operations and special actions

---

## ğŸ› Bug Fixes

### UI State Persistence
- **Fixed**: Hub page showing 0 cigars for non-currently-viewed humidors after navigation
- **Root Cause**: Global cigars array was being overwritten with only the current humidor's cigars
- **Solution**: Implemented smart array merging that preserves data for all humidors

### Database Type Handling
- **Fixed**: Server crashes due to type deserialization errors
- **Fixed**: "error serializing parameter" errors for nullable UUID columns
- **Fixed**: Incorrect DateTime type usage for purchase_date field

---

## ğŸ“Š API Changes

### New Endpoint

**POST /api/v1/cigars/:id/transfer**

Request body:
```json
{
  "destination_humidor_id": "uuid",
  "quantity": 5
}
```

Response (200 OK):
```json
{
  "message": "Successfully transferred 5 cigar(s) to destination humidor"
}
```

Error responses:
- `400`: Validation errors (invalid quantity, same humidor, insufficient cigars)
- `403`: Permission denied (no access to source or destination humidor)
- `404`: Cigar or humidor not found
- `500`: Internal server error

---

## ğŸ” Security

### Permission Enforcement
- Transfer operations verify ownership or edit permissions for both source and destination humidors
- Uses existing `verify_cigar_ownership()` and `verify_humidor_ownership()` helpers
- Maintains data isolation through user_id filtering
- Respects shared humidor permissions with proper edit access checks

---

## ğŸ“ Database

### Migration Status
No new migrations required. Uses existing schema with proper handling of nullable columns.

---

## ğŸš€ Upgrade Notes

This is a minor feature release with no breaking changes:

1. **Docker Users**: Pull latest image and restart containers
   ```bash
   docker compose down
   docker compose up -d
   ```

2. **Manual Deployment**: 
   ```bash
   cargo build --release
   # Restart application service
   ```

3. **No Database Changes**: Existing data remains fully compatible

---

## ğŸ“‹ Full Changelog

### Added
- Cigar transfer feature with modal UI
- Transfer button in cigar detail report card
- POST `/api/v1/cigars/:id/transfer` endpoint
- Transfer validation (quantity, permissions, humidor availability)
- Automatic hub refresh after transfer operations

### Fixed
- Global cigars array state management bug causing incorrect hub statistics
- Type mismatches for nullable UUID fields in transfer operations
- DateTime serialization for purchase_date field
- Route ordering conflicts with transfer endpoint

### Changed
- Improved showHumidorDetail() to maintain complete global cigar data
- Enhanced performTransfer() to refresh hub view after successful transfer

---

## ğŸ™ Acknowledgments

Thank you to all users who requested the cigar transfer feature. Your feedback continues to shape Humidor into a better application.

---

## ğŸ“ Support

- **Documentation**: [docs/USER_GUIDE.md](../docs/USER_GUIDE.md)
- **API Reference**: [docs/API.md](../docs/API.md)
- **Issues**: Please report bugs via GitHub Issues
