name: Scheduled Maintenance

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Dependency updates check - DISABLED during active development
  # Will re-enable during maintenance phase (RC/post-release)
  # See docs/DEPENDENCY_UPDATES_PLAN.md for migration strategy
  # dependency-updates:
  #   name: Check Dependency Updates
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     [... rest disabled ...]

  # Weekly security audit - ACTIVE (critical for security)
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        id: audit
        continue-on-error: true
        run: |
          cargo audit --json > audit.json
          cat audit.json

      - name: Create issue if vulnerabilities found
        if: steps.audit.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            
            let body = '## Security Vulnerabilities Found\n\n';
            body += 'âš ï¸ **Action Required**: Security vulnerabilities detected in dependencies.\n\n';
            
            if (audit.vulnerabilities && audit.vulnerabilities.list) {
              for (const vuln of audit.vulnerabilities.list) {
                body += `### ${vuln.advisory.id}: ${vuln.advisory.title}\n`;
                body += `- **Package**: ${vuln.package.name} ${vuln.package.version}\n`;
                body += `- **Severity**: ${vuln.advisory.severity}\n`;
                body += `- **Patched**: ${vuln.advisory.patched_versions.join(', ')}\n`;
                body += `- **Description**: ${vuln.advisory.description}\n`;
                body += `- **URL**: ${vuln.advisory.url}\n\n`;
              }
            }
            
            body += '\n\n**Action Items:**\n';
            body += '1. Review each vulnerability\n';
            body += '2. Update affected dependencies\n';
            body += '3. Test thoroughly after updates\n';
            body += '4. Deploy updated version\n';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'critical', 'dependencies']
            });

  # Check Docker base image updates
  docker-updates:
    name: Check Docker Base Image Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for newer Rust version
        id: rust-check
        run: |
          # Extract Rust version from Dockerfile (e.g., "1.91" from "rust:1.91-alpine")
          CURRENT_RUST=$(grep -m 1 'FROM rust:' Dockerfile | sed -n 's/.*FROM rust:\([0-9.]*\).*/\1/p')
          
          # Get latest stable Rust version from official channel
          LATEST_RUST=$(curl -s https://static.rust-lang.org/dist/channel-rust-stable.toml | grep -m 1 'version = ' | cut -d'"' -f2 | cut -d' ' -f1)
          
          echo "Current Rust version: $CURRENT_RUST"
          echo "Latest Rust version: $LATEST_RUST"
          
          # Validate that we got valid version strings
          if [ -z "$CURRENT_RUST" ] || [ -z "$LATEST_RUST" ]; then
            echo "Error: Could not determine Rust versions"
            echo "update_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "current=$CURRENT_RUST" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_RUST" >> $GITHUB_OUTPUT
          
          # Only alert on MAJOR version changes (e.g., 1.x -> 2.x)
          # Rust uses semantic versioning: MAJOR.MINOR.PATCH
          CURRENT_MAJOR=$(echo "$CURRENT_RUST" | cut -d. -f1)
          LATEST_MAJOR=$(echo "$LATEST_RUST" | cut -d. -f1)
          
          if [ "$CURRENT_MAJOR" != "$LATEST_MAJOR" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "MAJOR version update available: $CURRENT_MAJOR.x -> $LATEST_MAJOR.x"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Already on Rust $CURRENT_MAJOR.x (no major version change)"
          fi

      - name: Create issue if Rust update available
        if: steps.rust-check.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.rust-check.outputs.current }}';
            const latest = '${{ steps.rust-check.outputs.latest }}';
            
            const body = `## Rust Version Update Available\n\n` +
              `A new stable version of Rust is available.\n\n` +
              `- **Current**: ${current}\n` +
              `- **Latest**: ${latest}\n\n` +
              `**Steps to update:**\n` +
              `1. Update \`Dockerfile\` to use \`rust:${latest}-alpine\`\n` +
              `2. Test the build locally\n` +
              `3. Run full test suite\n` +
              `4. Update CI/CD if needed\n\n` +
              `**Note**: Using Alpine base image, so update should reference \`-alpine\` suffix.\n`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rust ${latest} Available (currently on ${current})`,
              body: body,
              labels: ['dependencies', 'docker', 'maintenance']
            });

  # Health check
  health-summary:
    name: Project Health Summary
    runs-on: ubuntu-latest
    needs: [security-audit, docker-updates]
    if: always()
    steps:
      - name: Project health summary
        run: |
          echo "## Project Health Check Complete"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Docker Updates: ${{ needs.docker-updates.result }}"
          echo ""
          echo "Note: Dependency update checks disabled during active development"
          echo "Will re-enable during maintenance phase (see DEPENDENCY_UPDATES_PLAN.md)"
