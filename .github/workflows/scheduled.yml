name: Scheduled Maintenance

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Check for dependency updates
  dependency-updates:
    name: Check Dependency Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-outdated
        run: cargo install cargo-outdated

      - name: Check for outdated dependencies
        id: outdated
        run: |
          cargo outdated --format json > outdated.json
          cat outdated.json
          
          # Count outdated dependencies
          OUTDATED_COUNT=$(jq '.dependencies | length' outdated.json)
          echo "outdated_count=$OUTDATED_COUNT" >> $GITHUB_OUTPUT

      - name: Create issue if dependencies are outdated
        if: steps.outdated.outputs.outdated_count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = JSON.parse(fs.readFileSync('outdated.json', 'utf8'));
            
            // Packages with known deferred updates (see DEPENDENCY_UPDATES_PLAN.md)
            const deferredPackages = [
              'warp',           // Phase 4: Requires hyper 1.x migration
              'hyper',          // Phase 4: Major rewrite, blocked by warp
              'http',           // Phase 4: Part of HTTP stack migration
              'http-body',      // Phase 4: Part of HTTP stack migration
              'h2',             // Phase 4: Part of HTTP stack migration
              'headers',        // Phase 4: Part of HTTP stack migration
              'headers-core',   // Phase 4: Part of HTTP stack migration
              'hyper-tls',      // Phase 4: Part of HTTP stack migration
            ];
            
            // Helper function to check if update is a major version change
            function isMajorUpdate(current, latest) {
              const currentMajor = parseInt(current.split('.')[0]);
              const latestMajor = parseInt(latest.split('.')[0]);
              return latestMajor > currentMajor;
            }
            
            // Filter for major version updates, excluding deferred packages
            const majorUpdates = outdated.dependencies.filter(dep => 
              isMajorUpdate(dep.project, dep.latest) && 
              !deferredPackages.includes(dep.name)
            );
            
            // Only create issue if there are actionable major updates
            if (majorUpdates.length === 0) {
              console.log('No actionable major version updates found.');
              const totalMajor = outdated.dependencies.filter(dep => 
                isMajorUpdate(dep.project, dep.latest)
              ).length;
              const deferredCount = totalMajor - majorUpdates.length;
              console.log(`Total outdated: ${outdated.dependencies.length}`);
              console.log(`Major updates deferred: ${deferredCount} (see DEPENDENCY_UPDATES_PLAN.md)`);
              return;
            }
            
            let body = '## Major Dependency Updates Available\n\n';
            body += `Found ${majorUpdates.length} actionable major version updates:\n\n`;
            body += '| Package | Current | Latest | Kind |\n';
            body += '|---------|---------|--------|------|\n';
            
            for (const dep of majorUpdates) {
              body += `| ${dep.name} | ${dep.project} | ${dep.latest} | ${dep.kind} |\n`;
            }
            
            // Note about deferred updates
            const deferredCount = outdated.dependencies.filter(dep => 
              isMajorUpdate(dep.project, dep.latest) && 
              deferredPackages.includes(dep.name)
            ).length;
            
            if (deferredCount > 0) {
              body += `\n\n_Note: ${deferredCount} major updates are intentionally deferred (HTTP stack migration). See [DEPENDENCY_UPDATES_PLAN.md](../blob/main/docs/DEPENDENCY_UPDATES_PLAN.md) for details._\n`;
            }
            
            if (outdated.dependencies.length > majorUpdates.length + deferredCount) {
              const minorCount = outdated.dependencies.length - majorUpdates.length - deferredCount;
              body += `\n\n_${minorCount} minor/patch updates are also available. Run \`cargo outdated\` locally to see all updates._\n`;
            }
            
            body += '\n\n**Action Required:**\n';
            body += '1. Review breaking changes in the changelog for each package\n';
            body += '2. Update `Cargo.toml` with new version requirements\n';
            body += '3. Run `cargo update` and fix any compilation errors\n';
            body += '4. Run full test suite to verify compatibility\n';
            body += '5. Consider minor/patch updates with `cargo update`\n';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸ”¼ Major Dependency Updates Available - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['dependencies', 'maintenance', 'breaking-change']
            });

  # Weekly security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        id: audit
        continue-on-error: true
        run: |
          cargo audit --json > audit.json
          cat audit.json

      - name: Create issue if vulnerabilities found
        if: steps.audit.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            
            let body = '## Security Vulnerabilities Found\n\n';
            body += 'âš ï¸ **Action Required**: Security vulnerabilities detected in dependencies.\n\n';
            
            if (audit.vulnerabilities && audit.vulnerabilities.list) {
              for (const vuln of audit.vulnerabilities.list) {
                body += `### ${vuln.advisory.id}: ${vuln.advisory.title}\n`;
                body += `- **Package**: ${vuln.package.name} ${vuln.package.version}\n`;
                body += `- **Severity**: ${vuln.advisory.severity}\n`;
                body += `- **Patched**: ${vuln.advisory.patched_versions.join(', ')}\n`;
                body += `- **Description**: ${vuln.advisory.description}\n`;
                body += `- **URL**: ${vuln.advisory.url}\n\n`;
              }
            }
            
            body += '\n\n**Action Items:**\n';
            body += '1. Review each vulnerability\n';
            body += '2. Update affected dependencies\n';
            body += '3. Test thoroughly after updates\n';
            body += '4. Deploy updated version\n';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ðŸš¨ Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'critical', 'dependencies']
            });

  # Check Docker base image updates
  docker-updates:
    name: Check Docker Base Image Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for newer Rust version
        id: rust-check
        run: |
          # Extract Rust version from Dockerfile (e.g., "1.90" from "rust:1.90-slim")
          CURRENT_RUST=$(grep -m 1 'FROM rust:' Dockerfile | sed -n 's/.*FROM rust:\([0-9.]*\).*/\1/p')
          
          # Get latest stable Rust version from official channel
          LATEST_RUST=$(curl -s https://static.rust-lang.org/dist/channel-rust-stable.toml | grep -m 1 'version = ' | cut -d'"' -f2 | cut -d' ' -f1)
          
          echo "Current Rust version: $CURRENT_RUST"
          echo "Latest Rust version: $LATEST_RUST"
          
          echo "current=$CURRENT_RUST" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_RUST" >> $GITHUB_OUTPUT
          
          # Compare versions (strip patch version for comparison if needed)
          CURRENT_MAJOR_MINOR=$(echo "$CURRENT_RUST" | cut -d. -f1,2)
          LATEST_MAJOR_MINOR=$(echo "$LATEST_RUST" | cut -d. -f1,2)
          
          if [ "$CURRENT_MAJOR_MINOR" != "$LATEST_MAJOR_MINOR" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "Update available: $CURRENT_MAJOR_MINOR -> $LATEST_MAJOR_MINOR"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "Already on latest major.minor version"
          fi

      - name: Create issue if Rust update available
        if: steps.rust-check.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.rust-check.outputs.current }}';
            const latest = '${{ steps.rust-check.outputs.latest }}';
            
            const body = `## Rust Version Update Available\n\n` +
              `A new stable version of Rust is available.\n\n` +
              `- **Current**: ${current}\n` +
              `- **Latest**: ${latest}\n\n` +
              `**Steps to update:**\n` +
              `1. Update \`Dockerfile\` to use \`rust:${latest}-slim\`\n` +
              `2. Test the build locally\n` +
              `3. Run full test suite\n` +
              `4. Update CI/CD if needed\n`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Rust ${latest} Available (currently on ${current})`,
              body: body,
              labels: ['dependencies', 'docker', 'maintenance']
            });

  # Health check
  health-summary:
    name: Project Health Summary
    runs-on: ubuntu-latest
    needs: [dependency-updates, security-audit, docker-updates]
    if: always()
    steps:
      - name: Project health summary
        run: |
          echo "## Project Health Check Complete"
          echo "Dependency Updates: ${{ needs.dependency-updates.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Docker Updates: ${{ needs.docker-updates.result }}"
