name: Scheduled Maintenance

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  # Dependency updates check - DISABLED during active development
  # Will re-enable during maintenance phase (RC/post-release)
  # See docs/DEPENDENCY_UPDATES_PLAN.md for migration strategy
  # dependency-updates:
  #   name: Check Dependency Updates
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout code
  #       uses: actions/checkout@v4
  #     [... rest disabled ...]

  # Weekly security audit - ACTIVE (critical for security)
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        id: audit
        continue-on-error: true
        run: |
          cargo audit --json > audit.json
          cat audit.json

      - name: Create issue if vulnerabilities found
        if: steps.audit.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const audit = JSON.parse(fs.readFileSync('audit.json', 'utf8'));
            
            let body = '## Security Vulnerabilities Found\n\n';
            body += '‚ö†Ô∏è **Action Required**: Security vulnerabilities detected in dependencies.\n\n';
            
            if (audit.vulnerabilities && audit.vulnerabilities.list) {
              for (const vuln of audit.vulnerabilities.list) {
                body += `### ${vuln.advisory.id}: ${vuln.advisory.title}\n`;
                body += `- **Package**: ${vuln.package.name} ${vuln.package.version}\n`;
                body += `- **Severity**: ${vuln.advisory.severity}\n`;
                body += `- **Patched**: ${vuln.advisory.patched_versions.join(', ')}\n`;
                body += `- **Description**: ${vuln.advisory.description}\n`;
                body += `- **URL**: ${vuln.advisory.url}\n\n`;
              }
            }
            
            body += '\n\n**Action Items:**\n';
            body += '1. Review each vulnerability\n';
            body += '2. Update affected dependencies\n';
            body += '3. Test thoroughly after updates\n';
            body += '4. Deploy updated version\n';
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Security Vulnerabilities Detected - ${new Date().toISOString().split('T')[0]}`,
              body: body,
              labels: ['security', 'critical', 'dependencies']
            });

  # Check Docker base image updates
  docker-updates:
    name: Check Docker Base Image Updates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for newer Rust version
        id: rust-check
        run: |
          # Extract Rust version from Dockerfile
          # Supports both floating tags (rust:1-alpine) and pinned (rust:1.91-alpine)
          DOCKERFILE_TAG=$(grep -m 1 'FROM rust:' Dockerfile | sed -n 's/.*FROM rust:\([^-]*\).*/\1/p')
          
          # Get latest stable Rust version from official channel
          LATEST_RUST=$(curl -s https://static.rust-lang.org/dist/channel-rust-stable.toml | grep -m 1 'version = ' | cut -d'"' -f2 | cut -d' ' -f1)
          
          echo "Dockerfile tag: $DOCKERFILE_TAG"
          echo "Latest Rust version: $LATEST_RUST"
          
          # Validate versions
          if [ -z "$DOCKERFILE_TAG" ] || [ -z "$LATEST_RUST" ]; then
            echo "Error: Could not determine Rust versions"
            echo "update_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if using floating tag (e.g., "1" instead of "1.91.0")
          if [ "$DOCKERFILE_TAG" = "1" ]; then
            echo "‚úì Using floating tag rust:1-alpine (auto-updates to latest 1.x)"
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "current=1.x (floating)" >> $GITHUB_OUTPUT
            echo "latest=$LATEST_RUST" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # For pinned versions, compare major versions only
          CURRENT_MAJOR=$(echo "$DOCKERFILE_TAG" | cut -d. -f1)
          LATEST_MAJOR=$(echo "$LATEST_RUST" | cut -d. -f1)
          
          echo "current=$DOCKERFILE_TAG" >> $GITHUB_OUTPUT
          echo "latest=$LATEST_RUST" >> $GITHUB_OUTPUT
          
          # Only alert if Rust 2.x or higher exists (very unlikely scenario)
          if [ "$CURRENT_MAJOR" != "$LATEST_MAJOR" ] && [ "$LATEST_MAJOR" -ge 2 ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è BREAKING CHANGE: Rust $LATEST_MAJOR.x available (currently on $CURRENT_MAJOR.x)"
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
            echo "‚úì On Rust $CURRENT_MAJOR.x series (latest: $LATEST_RUST)"
          fi

      - name: Create issue if MAJOR Rust version available
        if: steps.rust-check.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.rust-check.outputs.current }}';
            const latest = '${{ steps.rust-check.outputs.latest }}';
            
            const body = `## üö® BREAKING: New Rust Major Version Available\n\n` +
              `A new **major version** of Rust has been released. This is a significant change.\n\n` +
              `- **Current**: Rust ${current}\n` +
              `- **Latest**: Rust ${latest}\n\n` +
              `‚ö†Ô∏è **IMPORTANT**: Major version upgrades may include breaking changes.\n\n` +
              `**Required Actions:**\n` +
              `1. Review the [Rust release notes](https://github.com/rust-lang/rust/releases)\n` +
              `2. Update \`Dockerfile\` to use \`rust:${latest}-alpine\`\n` +
              `3. Fix any deprecation warnings or breaking changes\n` +
              `4. Run full test suite locally\n` +
              `5. Update CI/CD configuration if needed\n` +
              `6. Review \`docs/DEPENDENCY_UPDATES_PLAN.md\`\n\n` +
              `**Note**: This workflow only alerts on MAJOR version changes (e.g., 1.x ‚Üí 2.x). ` +
              `Minor updates within the 1.x series are handled automatically by the \`rust:1-alpine\` tag.\n`;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `üö® Rust ${latest} (MAJOR VERSION) Available - Currently on ${current}`,
              body: body,
              labels: ['dependencies', 'docker', 'maintenance', 'breaking-change']
            });

  # Health check
  health-summary:
    name: Project Health Summary
    runs-on: ubuntu-latest
    needs: [security-audit, docker-updates]
    if: always()
    steps:
      - name: Project health summary
        run: |
          echo "## Project Health Check Complete"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          echo "Docker Updates: ${{ needs.docker-updates.result }}"
          echo ""
          echo "Note: Dependency update checks disabled during active development"
          echo "Will re-enable during maintenance phase (see DEPENDENCY_UPDATES_PLAN.md)"
